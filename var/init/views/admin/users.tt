[% page_title = "Users" %]
[% INCLUDE admin/header_include.tt %]

<div class="row" ng-app="userApp" ng-controller="userCtrl" ng-cloak>

<div class="col-sm-7">

        <form class="form-search">
            <div class="input-group">
                <input class="form-control" type="text" ng-model="query" class="search-query">
                <span class="input-group-btn">
                        <button ng-click="search();" type="button" class="btn btn-primary">Search</button>
                </span>
            </div>
        </form>

<table class="table table-striped">
<thead>
<tr>
    <th>Username</th>
    <th>Real Name</th>
    <th>Email</th>
    <th>Last Login</th>
    <th></th>
</tr>
</thead>
<tbody id="users">
        <tr ng-repeat="user in users" id="{{user.id}}">
            <td><a href="/admin/user/{{user.id}}">{{user.username}}</a></td>
            <td>{{user.real_name}}</td>
            <td>{{user.email}}</td>
            <td>{{user.last_login|datetime:'medium'}}</td>
            <td><form action="{{become_url()}}" method="POST"><input type="submit" value="Become" class="btn btn-default"></form></td>
        </tr>
</tbody>
</table>
<pagination items-per-page="paging.items_per_page" page="paging.page_number" total-items="paging.total_items" direction-links="true" boundary-links="false" rotate="true" max-size=9 on-select-page="search(page)"></pagination>
</div><!-- col-sm-7 -->

    
<div class="col-sm-5">
        <form action="/admin/user" method="POST" class="form-horizontal">
                <fieldset>
                        <legend>Add A User</legend>
                        <div class="form-group">
                            <label class="col-sm-4 control-label" for="username">Username</label>
                            <div class="col-sm-8">
                                <input class="form-control" type="text" name="username" id="username">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label" for="real_name">Real Name</label>
                            <div class="col-sm-8">
                                <input class="form-control" type="text" name="real_name" id="real_name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label" for="email">Email</label>
                            <div class="col-sm-8">
                                <input class="form-control" type="text" name="email" id="email">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label" for="password">Password</label>
                            <div class="col-sm-8">
                                <input class="form-control" type="text" name="password" id="password">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-offset-4 col-sm-8">
                                <input class="btn btn-primary" type="submit" value="Create">
                            </div>
                        </div>
                </fieldset>
        </form>
</div><!-- col-sm-5 -->

</div><!-- row -->

[% foot_tags = BLOCK %]
[% INCLUDE angular_js_include.tt %]
[% INCLUDE bootstrapui_js_include.tt %]

<script type="text/javascript">
'use strict';

var userapp = angular.module('userApp', ['ui.bootstrap']);

userapp.config( function($httpProvider) {
    $httpProvider.defaults.withCredentials = true;
    $httpProvider.interceptors.push(wing.angular_http_interceptor);
});

userapp.filter('datetime', ['$filter', wing.angular_datetime_filter]);

userapp.controller('userCtrl', function($scope, $http, $filter, $q) {

    $scope.query   = ''; // what to search on
    $scope.users   = []  // list of user objects
    $scope.paging  = {}; // pagination data

    // glue between wing's paging data and the pagination here
    $scope.paginate = function (paging_data) {
        var start_number = 0;
        $scope.paging = paging_data;
        if (paging_data.total_pages > 1) {
            $scope.paging.has_pages = 1;
            start_number = (paging_data.page_number-1) * paging_data.items_per_page;
        }
        else {
            $scope.paging.has_pages = 0;
        }
        $scope.paging.start_number = start_number + 1;
    };
    
    // get a list of users with paging
    $scope.search = function (page_number) {
        var current_page = page_number ? page_number : 1;
        var params = {
            _page_number: current_page,
            _items_per_page: 2,
            query: $scope.query,
        };
        $http.get('/api/user', { params : params })
        .success(function (data) {
            $scope.users = data.result.items;
            $scope.paginate(data.result.paging);
        });
    };
    $scope.become_url = function() {
        var self = this;
        return '/admin/user/' + self.user.id  + '/become';
    };
    
});
</script>

[% END %]
[% INCLUDE admin/footer_include.tt %]
